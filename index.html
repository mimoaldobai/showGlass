<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>تجربة النظارات الافتراضية</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #333;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    /* الفيديو الذي يعرض الكاميرا */
    #videoElement {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
    }
    /* الكانفس لعرض مشهد Three.js */
    #threeCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      pointer-events: none;
    }
    /* زر التشغيل */
    #tryButton {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      font-size: 18px;
      cursor: pointer;
      z-index: 3;
      background-color: #007BFF;
      border: none;
      border-radius: 5px;
      color: #fff;
    }
  </style>
</head>
<body>
  <!-- عنصر الفيديو لعرض الكاميرا -->
  <video id="videoElement" autoplay playsinline muted></video>
  <!-- كانفس Three.js -->
  <canvas id="threeCanvas"></canvas>
  <!-- زر التجربة -->
  <button id="tryButton">TRY IT NOW</button>

  <!-- تضمين مكتبة Three.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <!-- GLTFLoader لتحميل نموذج glb -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <!-- مكتبة Mediapipe Face Mesh -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

  <script>
    /* المتغيرات العامة */
    let videoElement = document.getElementById('videoElement');
    let tryButton = document.getElementById('tryButton');
    let threeCanvas = document.getElementById('threeCanvas');

    let scene, camera, renderer, glassesModel;
    let faceMesh, mpCamera;
    
    /* دالة تهيئة مشهد Three.js */
    function initThree() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      renderer = new THREE.WebGLRenderer({ canvas: threeCanvas, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);

      // إضافة ضوء محيط
      let light = new THREE.AmbientLight(0xffffff, 1);
      scene.add(light);
      
      // وضع الكاميرا بحيث يكون النموذج أمامها
      camera.position.set(0, 0, 5);
    }
    
    /* تحميل نموذج النظارة (glass1.glb) */
    function loadGlasses() {
      const loader = new THREE.GLTFLoader();
      loader.load('glass1.glb', function(gltf) {
        glassesModel = gltf.scene;
        // يمكن تعديل المقياس والموقع حسب الحاجة
        glassesModel.scale.set(1, 1, 1);
        scene.add(glassesModel);
      }, undefined, function(error) {
        console.error('Error loading model:', error);
      });
    }
    
    /* تحديث موقع النظارة بناءً على معالم الوجه المكتشفة */
    function updateGlasses(landmarks) {
      if (!glassesModel) return;
      // استخدام معلمين من الوجه (مثلاً: 33 و263) لتحديد منتصف العينين
      let rightEye = landmarks[33];
      let leftEye = landmarks[263];
      // حساب مركز العينين
      let centerX = (rightEye.x + leftEye.x) / 2;
      let centerY = (rightEye.y + leftEye.y) / 2;
      
      // تحويل الإحداثيات من نسبية (0-1) إلى نظام Three.js (تقريباً)
      let posX = (centerX - 0.5) * 2; // تقريباً بين -1 و1
      let posY = -(centerY - 0.5) * 2;
      
      // تعيين موضع النموذج؛ يمكن تعديل القيمة لتناسب التطبيق
      glassesModel.position.set(posX, posY, 0);

      // تغيير المقياس بناءً على المسافة بين العينين (اختياري)
      let eyeDist = Math.hypot(rightEye.x - leftEye.x, rightEye.y - leftEye.y);
      let scale = eyeDist * 5;
      glassesModel.scale.set(scale, scale, scale);
    }
    
    /* تهيئة Mediapipe FaceMesh */
    function initFaceMesh() {
      faceMesh = new FaceMesh.FaceMesh({
        locateFile: (file) => {
          return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
        }
      });
      faceMesh.setOptions({
        maxNumFaces: 1,
        refineLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
      });
      faceMesh.onResults(onFaceResults);

      // استخدام مكتبة camera_utils من Mediapipe لالتقاط الفيديو
      mpCamera = new CameraUtils.Camera(videoElement, {
        onFrame: async () => {
          await faceMesh.send({ image: videoElement });
        },
        width: 640,
        height: 480
      });
      mpCamera.start();
    }
    
    /* دالة تُستدعى عند الحصول على نتائج تتبع الوجه */
    function onFaceResults(results) {
      if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
        let landmarks = results.multiFaceLandmarks[0];
        updateGlasses(landmarks);
      }
      renderer.render(scene, camera);
    }
    
    /* بدء التجربة الافتراضية */
    function startTryOn() {
      // تهيئة Three.js وتحميل النموذج
      initThree();
      loadGlasses();
      // تهيئة تتبع الوجه
      initFaceMesh();
    }
    
    /* عند النقر على زر "TRY IT NOW" */
    tryButton.addEventListener('click', function() {
      // طلب الكاميرا الأمامية
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
        .then(function(stream) {
          videoElement.srcObject = stream;
          videoElement.play();
          startTryOn();
          // إخفاء الزر بعد بدء التجربة
          tryButton.style.display = "none";
        })
        .catch(function(err) {
          console.error("Error accessing camera: " + err);
        });
    });
    
    /* تعديل حجم المشهد عند تغيير حجم النافذة */
    window.addEventListener('resize', () => {
      if (renderer && camera) {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }
    });
  </script>
</body>
</html>
